<!-- Main Application Layout - Modern Design -->
<div class="flex h-screen bg-gray-50 overflow-hidden">
  <!-- Sidebar -->
  <aside
    id="sidebar"
    class="w-64 bg-white border-r border-gray-200 flex flex-col transition-all duration-300 lg:relative absolute inset-y-0 left-0 z-30 transform lg:translate-x-0 -translate-x-full"
  >
    <!-- Logo -->
    <div
      class="h-16 flex items-center justify-between px-6 border-b border-gray-200"
    >
      <div class="flex items-center space-x-3">
        <div
          class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
        </div>
        <span class="text-lg font-bold text-gray-800">Booking</span>
      </div>
      <button
        onclick="toggleSidebar()"
        class="lg:hidden text-gray-500 hover:text-gray-700"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 overflow-y-auto py-4 px-3">
      <div class="space-y-1">
        <!-- Dashboard -->
        <a
          href="#"
          data-page="dashboard"
          class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
            ></path>
          </svg>
          <span class="font-medium">Dashboard</span>
        </a>

        <!-- Reports -->
        <a
          href="#"
          data-page="reports"
          class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            ></path>
          </svg>
          <span class="font-medium">รายงาน</span>
        </a>

        <!-- Bookings -->
        <a
          href="#"
          data-page="booking"
          class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
            ></path>
          </svg>
          <span class="font-medium">การจอง</span>
        </a>

        <!-- Payment Approval (AR/AP, Owner only) -->
        <a
          href="#"
          data-page="payment-approval"
          data-role="AR_AP,Owner,Cost"
          class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <span class="font-medium">อนุมัติการชำระเงิน</span>
        </a>

        <!-- Refund Items (AR/AP, Owner only) -->
        <a
          href="#"
          data-page="refund"
          data-role="AR_AP,Owner,Cost"
          class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"
            ></path>
          </svg>
          <span class="font-medium">รายการคืนเงิน</span>
        </a>

        <!-- Programs -->
        <a
          href="#"
          data-page="programs"
          class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
            ></path>
          </svg>
          <span class="font-medium">โปรแกรม</span>
        </a>

        <!-- Locations -->
        <a
          href="#"
          data-page="locations"
          class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
            ></path>
          </svg>
          <span class="font-medium">สถานที่</span>
        </a>

        <!-- Employees (Owner only) -->
        <a
          href="#"
          data-page="employees"
          data-role="Owner"
          class="sidebar-item hidden flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition-all duration-200"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
            ></path>
          </svg>
          <span class="font-medium">พนักงาน</span>
        </a>
      </div>
    </nav>

    <!-- User Profile -->
    <div class="p-4 border-t border-gray-200">
      <div
        class="flex items-center space-x-3 rounded-xl hover:bg-gray-50 cursor-pointer transition-all duration-200"
      >
        <div
          onclick="openProfileModal()"
          class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-semibold"
        >
          <span id="userInitial">A</span>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-semibold text-gray-800 truncate" id="userName">
            Admin
          </p>
          <p class="text-xs text-gray-500 truncate" id="userRole">Owner</p>
        </div>
        <button
          onclick="logout()"
          class="text-gray-400 hover:text-red-500 transition-colors"
          title="ออกจากระบบ"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Header -->
    <header
      class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6"
    >
      <!-- Mobile Menu Button -->
      <button
        onclick="toggleSidebar()"
        class="lg:hidden text-gray-500 hover:text-gray-700"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          ></path>
        </svg>
      </button>

      <!-- Page Title -->
      <div class="flex-1 lg:ml-0 ml-4">
        <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">
          Dashboard
        </h1>
        <p class="text-sm text-gray-500" id="pageSubtitle">ภาพรวมระบบ</p>
      </div>
    </header>

    <!-- Page Content -->
    <main class="flex-1 overflow-y-auto p-6">
      <!-- Dashboard Page -->
      <div id="page-dashboard" class="page-container active">
        <?!= include('PageDashboard'); ?>
      </div>

      <!-- Reports Page -->
      <div id="page-reports" class="page-container">
        <?!= include('PageReports'); ?>
      </div>

      <!-- Booking Page -->
      <div id="page-booking" class="page-container">
        <?!= include('PageBooking'); ?>
      </div>

      <!-- Payment Approval Page -->
      <div id="page-payment-approval" class="page-container">
        <?!= include('PagePaymentApproval'); ?>
      </div>

      <!-- Refund Page -->
      <div id="page-refund" class="page-container">
        <?!= include('PageRefund'); ?>
      </div>

      <!-- Programs Page -->
      <div id="page-programs" class="page-container">
        <?!= include('PagePrograms'); ?>
      </div>

      <!-- Locations Page -->
      <div id="page-locations" class="page-container">
        <?!= include('PageLocations'); ?>
      </div>

      <!-- Employees Page -->
      <div id="page-employees" class="page-container">
        <?!= include('PageEmployees'); ?>
      </div>
    </main>
  </div>

  <!-- Mobile Sidebar Overlay -->
  <div
    id="sidebarOverlay"
    class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-20 hidden"
    onclick="toggleSidebar()"
  ></div>
  <!-- Logout Confirmation Modal -->
  <div
    id="logoutModal"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center backdrop-blur-sm p-4"
  >
    <div
      id="logoutModalContent"
      class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden transform scale-95 opacity-0 transition-all duration-300"
    >
      <div
        class="bg-gradient-to-r from-gray-700 to-gray-900 p-6 flex items-center space-x-4 border-b border-gray-600"
      >
        <div
          class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center flex-shrink-0"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
            ></path>
          </svg>
        </div>
        <div>
          <h3 class="text-xl font-bold text-white">ต้องการออกจากระบบ?</h3>
          <p class="text-gray-300 text-sm">
            คุณแน่ใจหรือไม่ว่าต้องการออกจากระบบในตอนนี้
          </p>
        </div>
      </div>

      <div class="p-6">
        <div class="flex space-x-3">
          <button
            type="button"
            id="cancelLogoutBtn"
            onclick="closeLogoutModal()"
            class="flex-1 px-6 py-3 border-2 border-gray-100 text-gray-700 rounded-xl hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all font-bold"
          >
            ยกเลิก
          </button>
          <button
            type="button"
            id="confirmLogoutBtn"
            onclick="confirmLogout()"
            class="flex-1 px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 hover:shadow-lg shadow-red-100 active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed transition-all font-bold flex items-center justify-center space-x-2"
          >
            <span
              id="logoutSpinner"
              class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
            ></span>
            <span id="logoutBtnText">ออกจากระบบ</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /**
   * SHARED APP UTILITIES (UI Specific)
   */

  /**
   * Convert Thai Date Format to Input Format
   * Converts dd/MM/yyyy to yyyy-MM-dd for HTML date inputs
   */
  function convertThaiDateToInputFormat(thaiDate) {
    if (!thaiDate) return "";

    // Check if already in yyyy-MM-dd format
    if (/^\d{4}-\d{2}-\d{2}$/.test(thaiDate)) {
      return thaiDate;
    }

    // Parse dd/MM/yyyy format
    const parts = thaiDate.split("/");
    if (parts.length === 3) {
      const day = parts[0].padStart(2, "0");
      const month = parts[1].padStart(2, "0");
      const year = parts[2];
      return `${year}-${month}-${day}`;
    }

    return "";
  }

  // Shared Application Utilities
  window.AppUI = window.AppUI || {
    toggleLoading: function (
      btnId,
      spinnerId,
      textId,
      isLoading,
      defaultText,
      loadingText,
    ) {
      const btn = document.getElementById(btnId);
      const spinner = document.getElementById(spinnerId);
      const text = document.getElementById(textId);
      if (isLoading) {
        if (btn) btn.disabled = true;
        if (spinner) spinner.classList.remove("hidden");
        if (text) text.textContent = loadingText;
      } else {
        if (btn) btn.disabled = false;
        if (spinner) spinner.classList.add("hidden");
        if (text) text.textContent = defaultText;
      }
    },
    // Wrappers for global formatters to maintain backward compatibility
    formatCurrency: function (num) {
      return formatCurrency(num);
    },
    formatDate: function (dateStr) {
      return formatDate(dateStr);
    },
  };
  var AppUI = window.AppUI;

  /**
   * SHARED PAGINATION SYSTEM
   */
  window.AppPagination = window.AppPagination || {
    render: function (config) {
      const {
        currentPage,
        itemsPerPage,
        totalItems,
        onPageChange,
        containerIds = {},
      } = config;

      const ids = {
        info: containerIds.info || "paginationInfo",
        mobile: containerIds.mobile || "mobilePageInfo",
        prev: containerIds.prev || "prevPageBtn",
        next: containerIds.next || "nextPageBtn",
        numbers: containerIds.numbers || "pageNumbers",
        ...containerIds,
      };

      const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;

      const infoEl = document.getElementById(ids.info);
      if (infoEl)
        infoEl.textContent = `หน้า ${currentPage} จาก ${totalPages} (${totalItems} รายการ)`;

      const mobileEl = document.getElementById(ids.mobile);
      if (mobileEl) mobileEl.textContent = `${currentPage} / ${totalPages}`;

      const prevBtn = document.getElementById(ids.prev);
      if (prevBtn) prevBtn.disabled = currentPage <= 1;

      const nextBtn = document.getElementById(ids.next);
      if (nextBtn)
        nextBtn.disabled = currentPage >= totalPages || totalItems === 0;

      const numbersEl = document.getElementById(ids.numbers);
      if (numbersEl) {
        let html = "";
        let start = Math.max(1, currentPage - 2);
        let end = Math.min(totalPages, start + 4);
        if (end - start < 4) start = Math.max(1, end - 4);

        for (let i = start; i <= end; i++) {
          html += `
            <button onclick="${onPageChange}(${i})" class="w-10 h-10 flex items-center justify-center rounded-lg border text-sm font-bold transition-all ${
              i === currentPage
                ? "bg-purple-600 text-white border-purple-600 shadow-lg shadow-purple-200"
                : "bg-white text-gray-600 border-gray-200 hover:bg-gray-50"
            }">
              ${i}
            </button>
          `;
        }
        numbersEl.innerHTML = html;
      }
    },
    getPaginatedItems: function (items, page, perPage) {
      const start = (page - 1) * perPage;
      return items.slice(start, start + perPage);
    },
  };
  var AppPagination = window.AppPagination;

  /**
   * Page State Management (localStorage)
   */
  function saveCurrentPage(pageName) {
    try {
      localStorage.setItem("currentPage", pageName);
    } catch (error) {
      console.error("Error saving page state:", error);
    }
  }

  function getCurrentPage() {
    try {
      return localStorage.getItem("currentPage");
    } catch (error) {
      console.error("Error reading page state:", error);
      return null;
    }
  }

  /**
   * Load User Info (Optimized)
   */
  function loadUserInfo() {
    const session = getSessionFromStorage();

    if (!session || !session.sessionToken) {
      loadPage("login");
      return;
    }

    // Use cached data
    const currentUser = {
      userId: session.userId,
      username: session.username,
      fullName: session.fullName,
      role: session.role,
    };

    // Update UI
    document.getElementById("userName").textContent =
      currentUser.fullName || currentUser.username;
    document.getElementById("userRole").textContent = currentUser.role;
    document.getElementById("userInitial").textContent = currentUser.fullName
      ? currentUser.fullName.charAt(0).toUpperCase()
      : currentUser.username.charAt(0).toUpperCase();

    // 1. Refresh Menu (Click handlers and fallback visibility)
    loadMenu(currentUser.role);

    // 2. Navigate (Already pre-set by index.html, but confirms state)
    let activePage = getCurrentPage();
    if (!activePage) {
      // Fallback logic
      if (currentUser.role === "OP") activePage = "booking";
      else if (["Admin", "Cost", "Owner"].includes(currentUser.role))
        activePage = "dashboard";
      else if (currentUser.role === "AR_AP") activePage = "payment-approval";
      else activePage = "booking";
    }
    navigateTo(activePage);

    // Validate in background
    google.script.run
      .withSuccessHandler(function (response) {
        if (!response.success) {
          showToast("Session หมดอายุ กรุณาเข้าสู่ระบบใหม่", "error");
          setTimeout(() => {
            clearSessionStorage();
            localStorage.removeItem("currentPage"); // ลบ page state
            loadPage("login");
          }, 1500);
        }
      })
      .withFailureHandler(function (error) {
        console.error("Session validation error:", error);
      })
      .getCurrentUser(session.sessionToken);
  }

  /**
   * Load Menu based on Role
   */
  function loadMenu(role) {
    const menuItems = document.querySelectorAll(".sidebar-item");
    if (menuItems.length === 0) return;

    menuItems.forEach((item) => {
      // Visibility is managed by index.html pre-filtering and style.html CSS rules.
    });

    // Add click handlers (Using a more specific check to handle re-injection)
    const navMenu = document.querySelector("#sidebar nav");
    if (navMenu && !navMenu.dataset.menuInitialized) {
      navMenu.addEventListener("click", function (e) {
        const item = e.target.closest(".sidebar-item");
        if (item) {
          e.preventDefault();
          const pageName = item.getAttribute("data-page");
          if (pageName) {
            navigateTo(pageName);
            if (window.innerWidth < 1024) toggleSidebar();
          }
        }
      });
      navMenu.dataset.menuInitialized = "true";
    }
  }

  /**
   * Navigate to Page (with State Save)
   */
  function navigateTo(pageName) {
    // Hide all pages
    document.querySelectorAll(".page-container").forEach((page) => {
      page.classList.remove("active");
    });

    // Show selected page
    const targetPage = document.getElementById(`page-${pageName}`);
    if (targetPage) {
      targetPage.classList.add("active");

      // Update active menu
      document.querySelectorAll(".sidebar-item").forEach((item) => {
        item.classList.remove("active");
      });
      const activeMenu = document.querySelector(`[data-page="${pageName}"]`);
      if (activeMenu) {
        activeMenu.classList.add("active");
      }

      // Update page title
      const titles = {
        dashboard: { title: "Dashboard", subtitle: "ภาพรวมระบบ" },
        booking: {
          title: "จัดการการจอง",
          subtitle: "สร้างและจัดการการจองทัวร์",
        },
        employees: {
          title: "จัดการพนักงาน",
          subtitle: "จัดการข้อมูลพนักงานและสิทธิ์",
        },
        programs: { title: "จัดการโปรแกรม", subtitle: "จัดการโปรแกรมทัวร์" },
        locations: {
          title: "จัดการสถานที่",
          subtitle: "จัดการสถานที่ท่องเที่ยว",
        },
        "payment-approval": {
          title: "อนุมัติการชำระเงิน",
          subtitle: "จัดการและอนุมัติการชำระเงิน",
        },
        reports: { title: "รายงาน", subtitle: "รายงานและสถิติ" },
        refund: {
          title: "จัดการการคืนเงิน",
          subtitle: "ระบบบันทึกและติดตามรายการคืนเงิน",
        },
      };

      if (titles[pageName]) {
        document.getElementById("pageTitle").textContent =
          titles[pageName].title;
        document.getElementById("pageSubtitle").textContent =
          titles[pageName].subtitle;
      }

      // Save current page state
      saveCurrentPage(pageName);

      // Call page load function
      loadPageContent(pageName);
    }
  }

  /**
   * Load Page Content
   */
  function loadPageContent(pageName) {
    const pageElement = document.getElementById(`page-${pageName}`);
    if (!pageElement) return;

    // Call page-specific load function
    const loadFunctions = {
      dashboard: "loadDashboard",
      booking: "loadBookings",
      employees: "loadEmployees",
      programs: "loadPrograms",
      locations: "loadLocations",
      "payment-approval": "loadPaymentApproval",
      reports: "loadReports",
      refund: "loadRefundPage",
    };

    const functionName = loadFunctions[pageName];
    if (functionName && typeof window[functionName] === "function") {
      window[functionName]();
    }
  }

  /**
   * Toggle Sidebar (Mobile)
   */
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebarOverlay");

    sidebar.classList.toggle("-translate-x-full");
    overlay.classList.toggle("hidden");
  }

  /**
   * Logout
   */
  function logout(force = false) {
    if (force) {
      handleFinalLogout();
      return;
    }

    const modal = document.getElementById("logoutModal");
    const content = document.getElementById("logoutModalContent");

    modal.classList.remove("hidden");
    setTimeout(() => {
      content.classList.remove("scale-95", "opacity-0");
      content.classList.add("scale-100", "opacity-100");
    }, 10);
  }

  function closeLogoutModal() {
    const modal = document.getElementById("logoutModal");
    const content = document.getElementById("logoutModalContent");

    content.classList.remove("scale-100", "opacity-100");
    content.classList.add("scale-95", "opacity-0");
    setTimeout(() => modal.classList.add("hidden"), 300);
  }

  function confirmLogout() {
    const btn = document.getElementById("confirmLogoutBtn");
    const cancelBtn = document.getElementById("cancelLogoutBtn");
    const spinner = document.getElementById("logoutSpinner");
    const text = document.getElementById("logoutBtnText");

    // Start Loading
    btn.disabled = true;
    cancelBtn.disabled = true;
    spinner.classList.remove("hidden");
    text.textContent = "กำลังออกจากระบบ...";

    // Wait 0.8 seconds then proceed
    setTimeout(() => {
      handleFinalLogout();
    }, 800);
  }

  function handleFinalLogout() {
    clearSessionStorage();
    localStorage.removeItem("currentPage");
    showToast("ออกจากระบบสำเร็จ", "success");

    setTimeout(() => {
      loadPage("login");
    }, 500);
  }

  // 1. Initial Quick Load (Pre-navigation)
  var initialSession = getSessionFromStorage();
  if (initialSession && initialSession.role) {
    loadMenu(initialSession.role);
  }

  // 2. Full Init
  loadUserInfo();
</script>
<!-- Modal Profile -->
<?!= include('ModalProfile'); ?>
