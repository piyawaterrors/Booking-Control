<!-- Payment Approval Page - Modern UI -->
<div class="space-y-6">
  <!-- Header Actions -->
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
  >
    <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto items-center">
      <!-- Refresh Button -->
      <button
        onclick="refreshPaymentData()"
        class="hidden sm:flex p-3 bg-white border-2 border-gray-100 rounded-xl text-gray-500 hover:text-purple-600 hover:border-purple-100 hover:bg-purple-50 transition-all duration-200 shadow-sm"
        title="รีเฟรชข้อมูล"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          ></path>
        </svg>
      </button>

      <!-- Search -->
      <div class="relative flex-1 sm:w-64">
        <input
          type="text"
          id="searchPayment"
          placeholder="ค้นหารหัสการจอง, สถานที่..."
          onkeyup="filterPayments()"
          class="w-full pl-10 pr-4 py-3 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all duration-200"
        />
        <svg
          class="w-5 h-5 text-gray-400 absolute left-3 top-3.5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          ></path>
        </svg>
      </div>

      <!-- Filter by Status -->
      <select
        id="filterPaymentStatus"
        onchange="filterPayments()"
        class="w-full sm:w-auto px-4 py-3 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all duration-200 bg-white select-modern"
      >
        <option value="">ทุกสถานะ</option>
        <option value="Pending">รอดำเนินการ</option>
        <option value="Confirm">ยืนยันแล้ว</option>
        <option value="Complete">เสร็จสิ้น</option>
        <option value="Cancel">ยกเลิก</option>
      </select>
    </div>

    <!-- Summary Stats -->
    <div
      class="w-full md:w-auto bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg shadow-purple-200"
    >
      <div class="text-sm opacity-90">รายการทั้งหมด</div>
      <div class="text-2xl font-bold" id="totalPayments">0</div>
    </div>
  </div>

  <!-- Payment Table Container (Desktop) -->
  <div
    class="hidden lg:block bg-white rounded-2xl shadow-xl shadow-gray-100 overflow-hidden border border-gray-100"
  >
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gray-50 border-b border-gray-100">
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            รหัสการจอง
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            วันที่จอง
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            วันที่เดินทาง
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สถานที่/โปรแกรม
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            ยอดรวม
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สถานะ
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สลิป
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            จัดการ
          </th>
        </tr>
      </thead>
      <tbody id="paymentTableBody" class="divide-y divide-gray-100">
        <tr>
          <td colspan="8" class="px-6 py-12 text-center text-gray-400">
            <div class="flex flex-col items-center space-y-3">
              <div
                class="w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"
              ></div>
              <span>กำลังดึงข้อมูล...</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Payment List Container (Mobile/Tablet) -->
  <div
    id="paymentGridBody"
    class="lg:hidden grid grid-cols-1 md:grid-cols-2 gap-4"
  >
    <!-- Mobile cards will be rendered here -->
  </div>

  <!-- Empty State -->
  <div
    id="emptyPaymentState"
    class="hidden text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-100"
  >
    <div
      class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <svg
        class="w-10 h-10 text-gray-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
        ></path>
      </svg>
    </div>
    <h3 class="text-lg font-bold text-gray-900">ไม่พบรายการจอง</h3>
    <p class="text-gray-500">ไม่มีรายการจองที่ตรงกับเงื่อนไขที่เลือก</p>
  </div>
</div>

<!-- View Payment Detail Modal -->
<div
  id="viewPaymentModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 transition-opacity duration-300"
>
  <div
    id="viewPaymentModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0"
  >
    <!-- Modal Header -->
    <div
      class="sticky top-0 bg-gradient-to-r from-indigo-600 to-purple-600 p-6 flex items-center justify-between border-b border-indigo-500 z-10"
    >
      <div class="flex items-center space-x-3">
        <div
          class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
            ></path>
          </svg>
        </div>
        <div>
          <h3 class="text-xl font-bold text-white">รายละเอียดการจอง</h3>
          <p class="text-indigo-100 text-sm" id="viewPaymentSubtitle">-</p>
        </div>
      </div>
      <button
        onclick="closeViewPaymentModal()"
        class="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all duration-200"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div id="viewPaymentContent" class="p-6">
      <!-- Content will be inserted here -->
    </div>
  </div>
</div>

<!-- Update Status Modal -->
<div
  id="updateStatusModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 transition-opacity duration-300"
>
  <div
    id="updateStatusModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0"
  >
    <!-- Modal Header -->
    <div
      class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 flex items-center justify-between border-b border-purple-500"
    >
      <div class="flex items-center space-x-3">
        <div
          class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
            ></path>
          </svg>
        </div>
        <div>
          <h3 class="text-xl font-bold text-white">เปลี่ยนสถานะการจอง</h3>
        </div>
      </div>
      <button
        onclick="closeUpdateStatusModal()"
        class="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all duration-200"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <input type="hidden" id="statusBookingId" />

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >สถานะปัจจุบัน</label
        >
        <div id="currentStatusDisplay" class="text-lg font-semibold"></div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >สถานะใหม่ <span class="text-red-500">*</span></label
        >
        <select
          id="newStatusSelect"
          class="w-full px-4 py-3 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all duration-200 bg-white"
        >
          <option value="">-- เลือกสถานะ --</option>
          <option value="Pending">รอดำเนินการ (Pending)</option>
          <option value="Confirm">ยืนยันแล้ว (Confirm)</option>
          <option value="Complete">เสร็จสิ้น (Complete)</option>
          <option value="Cancel">ยกเลิก (Cancel)</option>
        </select>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >เหตุผล (สำหรับการยกเลิก)</label
        >
        <textarea
          id="statusReasonText"
          rows="3"
          class="w-full px-4 py-3 border-2 border-gray-100 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-4 focus:ring-purple-100 transition-all duration-200"
          placeholder="ระบุเหตุผล..."
        ></textarea>
      </div>

      <div class="mb-6">
        <label class="flex items-center cursor-pointer">
          <input
            type="checkbox"
            id="generateDocumentCheck"
            class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
          />
          <span class="ml-2 text-sm text-gray-700"
            >ออกเอกสาร (Invoice/Receipt) อัตโนมัติ</span
          >
        </label>
      </div>

      <div class="flex justify-end space-x-3 pt-4 border-t">
        <button
          type="button"
          onclick="closeUpdateStatusModal()"
          class="px-6 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-semibold"
        >
          ยกเลิก
        </button>
        <button
          type="button"
          onclick="confirmStatusUpdate()"
          id="confirmStatusBtn"
          class="btn-primary px-6 py-2 text-white rounded-lg flex items-center space-x-2"
        >
          <span
            id="statusBtnSpinner"
            class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
          ></span>
          <span id="statusBtnText">บันทึก</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let allPayments = [];
  let currentPayment = null;

  // Initialize
  function loadPaymentApproval() {
    loadPayments();
  }

  // Load Payments
  function loadPayments() {
    const session = getSessionFromStorage();
    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    showPaymentLoading();

    const filterStatus = document.getElementById("filterPaymentStatus")?.value;

    google.script.run
      .withSuccessHandler(onPaymentsLoaded)
      .withFailureHandler(onPaymentError)
      .getBookingsForApproval(session.sessionToken, filterStatus || null);
  }

  function refreshPaymentData() {
    loadPayments();
  }

  function onPaymentsLoaded(response) {
    hidePaymentLoading();

    if (!response.success) {
      showToast(response.message, "error");
      if (response.message.includes("Session")) {
        setTimeout(() => {
          window.location.href = "?page=login";
        }, 2000);
      }
      return;
    }

    allPayments = response.data;
    displayPayments(allPayments);
  }

  function displayPayments(payments) {
    const tbody = document.getElementById("paymentTableBody");
    const gridBody = document.getElementById("paymentGridBody");
    const emptyState = document.getElementById("emptyPaymentState");

    document.getElementById("totalPayments").textContent = payments.length;

    if (payments.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="px-6 py-12 text-center text-gray-400">
            <div class="flex flex-col items-center space-y-3">
              <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center">
                <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <span class="text-lg font-semibold">ไม่พบรายการจอง</span>
            </div>
          </td>
        </tr>
      `;
      gridBody.innerHTML = "";
      emptyState.classList.remove("hidden");
      return;
    }

    emptyState.classList.add("hidden");

    // Desktop Table
    tbody.innerHTML = payments
      .map(
        (payment) => `
      <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick='viewPaymentDetail(${JSON.stringify(
        payment
      ).replace(/'/g, "&#39;")})'>
        <td class="px-6 py-4">
          <div class="text-sm font-bold text-gray-900">${
            payment.bookingId
          }</div>
          <div class="text-xs text-gray-500">โดย: ${payment.createdBy}</div>
        </td>
        <td class="px-6 py-4 text-sm text-gray-700">${payment.bookingDate}</td>
        <td class="px-6 py-4 text-sm text-gray-700">${payment.travelDate}</td>
        <td class="px-6 py-4">
          <div class="text-sm font-medium text-gray-900">${
            payment.location
          }</div>
          <div class="text-xs text-gray-500">${payment.program}</div>
        </td>
        <td class="px-6 py-4">
          <div class="text-sm font-bold text-gray-900">${Number(
            payment.totalAmount
          ).toLocaleString()} ฿</div>
          <div class="text-xs text-gray-500">${payment.adults} ผู้ใหญ่, ${
          payment.children
        } เด็ก</div>
        </td>
        <td class="px-6 py-4 text-center">
          ${getStatusBadge(payment.status)}
        </td>
        <td class="px-6 py-4 text-center">
          ${
            payment.slipUrl
              ? `<a href="${payment.slipUrl}" target="_blank" onclick="event.stopPropagation()" class="inline-flex items-center px-3 py-1 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                </a>`
              : '<span class="text-gray-400">-</span>'
          }
        </td>
        <td class="px-6 py-4 text-center">
          <button 
            onclick='event.stopPropagation(); openUpdateStatusModal(${JSON.stringify(
              payment
            ).replace(/'/g, "&#39;")})' 
            class="inline-flex items-center px-3 py-1 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition-all font-medium"
          >
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            เปลี่ยนสถานะ
          </button>
        </td>
      </tr>
    `
      )
      .join("");

    // Mobile Cards
    gridBody.innerHTML = payments
      .map(
        (payment) => `
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition-all cursor-pointer" onclick='viewPaymentDetail(${JSON.stringify(
        payment
      ).replace(/'/g, "&#39;")})'>
        <div class="flex justify-between items-start mb-3">
          <div>
            <div class="text-sm font-bold text-gray-900">${
              payment.bookingId
            }</div>
            <div class="text-xs text-gray-500">${payment.bookingDate}</div>
          </div>
          ${getStatusBadge(payment.status)}
        </div>
        <div class="space-y-2">
          <div class="text-sm font-medium text-gray-900">${
            payment.location
          }</div>
          <div class="text-xs text-gray-500">${payment.program}</div>
          <div class="flex justify-between items-center pt-2 border-t">
            <span class="text-sm font-bold text-purple-600">${Number(
              payment.totalAmount
            ).toLocaleString()} ฿</span>
            <button 
              onclick='event.stopPropagation(); openUpdateStatusModal(${JSON.stringify(
                payment
              ).replace(/'/g, "&#39;")})' 
              class="text-xs px-3 py-1 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100"
            >
              เปลี่ยนสถานะ
            </button>
          </div>
        </div>
      </div>
    `
      )
      .join("");
  }

  function getStatusBadge(status) {
    const statusMap = {
      Pending: {
        class: "bg-yellow-100 text-yellow-800",
        text: "รอดำเนินการ",
      },
      Confirm: { class: "bg-blue-100 text-blue-800", text: "ยืนยันแล้ว" },
      Complete: { class: "bg-green-100 text-green-800", text: "เสร็จสิ้น" },
      Cancel: { class: "bg-red-100 text-red-800", text: "ยกเลิก" },
    };

    const statusInfo = statusMap[status] || {
      class: "bg-gray-100 text-gray-800",
      text: status,
    };
    return `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusInfo.class}">${statusInfo.text}</span>`;
  }

  function filterPayments() {
    const searchTerm = document
      .getElementById("searchPayment")
      ?.value.toLowerCase();
    const statusFilter = document.getElementById("filterPaymentStatus")?.value;

    let filtered = allPayments;

    if (statusFilter) {
      filtered = filtered.filter((p) => p.status === statusFilter);
    }

    if (searchTerm) {
      filtered = filtered.filter(
        (p) =>
          p.bookingId.toLowerCase().includes(searchTerm) ||
          p.location.toLowerCase().includes(searchTerm) ||
          p.program.toLowerCase().includes(searchTerm) ||
          (p.agent && p.agent.toLowerCase().includes(searchTerm))
      );
    }

    displayPayments(filtered);
  }

  // View Payment Detail
  function viewPaymentDetail(payment) {
    currentPayment = payment;

    const content = `
      <div class="space-y-6">
        <!-- Booking Info Grid -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs text-gray-500 uppercase tracking-wide">รหัสการจอง</label>
            <div class="text-sm font-bold text-gray-900 mt-1">${
              payment.bookingId
            }</div>
          </div>
          <div>
            <label class="text-xs text-gray-500 uppercase tracking-wide">สถานะ</label>
            <div class="mt-1">${getStatusBadge(payment.status)}</div>
          </div>
          <div>
            <label class="text-xs text-gray-500 uppercase tracking-wide">วันที่จอง</label>
            <div class="text-sm font-semibold text-gray-900 mt-1">${
              payment.bookingDate
            }</div>
          </div>
          <div>
            <label class="text-xs text-gray-500 uppercase tracking-wide">วันที่เดินทาง</label>
            <div class="text-sm font-semibold text-gray-900 mt-1">${
              payment.travelDate
            }</div>
          </div>
        </div>

        <!-- Location & Program -->
        <div class="bg-gray-50 rounded-xl p-4">
          <label class="text-xs text-gray-500 uppercase tracking-wide">สถานที่และโปรแกรม</label>
          <div class="text-sm font-bold text-gray-900 mt-1">${
            payment.location
          }</div>
          <div class="text-sm text-gray-600 mt-1">${payment.program}</div>
        </div>

        <!-- Pricing Details -->
        <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl p-4">
          <h3 class="font-bold text-gray-900 mb-3">รายละเอียดราคา</h3>
          <div class="space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">ผู้ใหญ่ (${
                payment.adults
              } คน × ${Number(payment.adultPrice).toLocaleString()} ฿)</span>
              <span class="font-bold text-gray-900">${(
                payment.adults * payment.adultPrice
              ).toLocaleString()} ฿</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">เด็ก (${
                payment.children
              } คน × ${Number(payment.childPrice).toLocaleString()} ฿)</span>
              <span class="font-bold text-gray-900">${(
                payment.children * payment.childPrice
              ).toLocaleString()} ฿</span>
            </div>
            <div class="flex justify-between text-sm text-red-600">
              <span>ส่วนลด</span>
              <span class="font-bold">-${Number(
                payment.discount
              ).toLocaleString()} ฿</span>
            </div>
            <div class="border-t-2 border-purple-300 pt-2 mt-2 flex justify-between">
              <span class="font-bold text-gray-900">ยอดรวมทั้งสิ้น</span>
              <span class="text-xl font-bold text-purple-600">${Number(
                payment.totalAmount
              ).toLocaleString()} ฿</span>
            </div>
          </div>
        </div>

        ${
          payment.agent
            ? `
          <div>
            <label class="text-xs text-gray-500 uppercase tracking-wide">Agent/ช่องทาง</label>
            <div class="text-sm font-semibold text-gray-900 mt-1">${payment.agent}</div>
          </div>
        `
            : ""
        }

        ${
          payment.note
            ? `
          <div>
            <label class="text-xs text-gray-500 uppercase tracking-wide">หมายเหตุ</label>
            <div class="text-sm text-gray-700 mt-1">${payment.note}</div>
          </div>
        `
            : ""
        }

        ${
          payment.slipUrl
            ? `
          <div>
            <label class="text-xs text-gray-500 uppercase tracking-wide block mb-2">สลิปการชำระเงิน</label>
            <a href="${payment.slipUrl}" target="_blank" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              ดูสลิป
            </a>
          </div>
        `
            : ""
        }

        <!-- Created/Updated Info -->
        <div class="text-xs text-gray-500 border-t pt-4 space-y-1">
          <div>สร้างโดย: ${payment.createdBy} (${payment.createdAt})</div>
          ${
            payment.updatedBy
              ? `<div>แก้ไขล่าสุดโดย: ${payment.updatedBy} (${payment.updatedAt})</div>`
              : ""
          }
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3 pt-4 border-t">
          <button 
            onclick='openUpdateStatusModal(${JSON.stringify(payment).replace(
              /'/g,
              "&#39;"
            )})' 
            class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all font-semibold"
          >
            เปลี่ยนสถานะ
          </button>
          <button 
            onclick="closeViewPaymentModal()" 
            class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition-all font-semibold"
          >
            ปิด
          </button>
        </div>
      </div>
    `;

    document.getElementById("viewPaymentSubtitle").textContent =
      payment.bookingId;
    document.getElementById("viewPaymentContent").innerHTML = content;

    const modal = document.getElementById("viewPaymentModal");
    const modalContent = document.getElementById("viewPaymentModalContent");

    modal.classList.remove("hidden");
    setTimeout(() => {
      modalContent.classList.remove("scale-95", "opacity-0");
      modalContent.classList.add("scale-100", "opacity-100");
    }, 10);
  }

  function closeViewPaymentModal() {
    const modal = document.getElementById("viewPaymentModal");
    const modalContent = document.getElementById("viewPaymentModalContent");

    modalContent.classList.remove("scale-100", "opacity-100");
    modalContent.classList.add("scale-95", "opacity-0");
    setTimeout(() => modal.classList.add("hidden"), 300);
  }

  // Update Status Modal
  function openUpdateStatusModal(payment) {
    currentPayment = payment;

    document.getElementById("statusBookingId").value = payment.bookingId;
    document.getElementById("currentStatusDisplay").innerHTML = getStatusBadge(
      payment.status
    );
    document.getElementById("newStatusSelect").value = "";
    document.getElementById("statusReasonText").value = "";
    document.getElementById("generateDocumentCheck").checked = false;

    const modal = document.getElementById("updateStatusModal");
    const modalContent = document.getElementById("updateStatusModalContent");

    modal.classList.remove("hidden");
    setTimeout(() => {
      modalContent.classList.remove("scale-95", "opacity-0");
      modalContent.classList.add("scale-100", "opacity-100");
    }, 10);
  }

  function closeUpdateStatusModal() {
    const modal = document.getElementById("updateStatusModal");
    const modalContent = document.getElementById("updateStatusModalContent");

    modalContent.classList.remove("scale-100", "opacity-100");
    modalContent.classList.add("scale-95", "opacity-0");
    setTimeout(() => modal.classList.add("hidden"), 300);
  }

  function confirmStatusUpdate() {
    const session = getSessionFromStorage();
    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    const bookingId = document.getElementById("statusBookingId").value;
    const newStatus = document.getElementById("newStatusSelect").value;
    const reason = document.getElementById("statusReasonText").value;
    const generateDocument = document.getElementById(
      "generateDocumentCheck"
    ).checked;

    if (!newStatus) {
      showToast("กรุณาเลือกสถานะใหม่", "error");
      return;
    }

    if (newStatus === "Cancel" && !reason) {
      showToast("กรุณาระบุเหตุผลในการยกเลิก", "error");
      return;
    }

    // Show loading
    const btn = document.getElementById("confirmStatusBtn");
    const spinner = document.getElementById("statusBtnSpinner");
    const text = document.getElementById("statusBtnText");

    btn.disabled = true;
    spinner.classList.remove("hidden");
    text.textContent = "กำลังบันทึก...";

    google.script.run
      .withSuccessHandler(onStatusUpdated)
      .withFailureHandler(onPaymentError)
      .updateBookingStatus(
        session.sessionToken,
        bookingId,
        newStatus,
        reason,
        generateDocument
      );
  }

  function onStatusUpdated(response) {
    // Reset button
    const btn = document.getElementById("confirmStatusBtn");
    const spinner = document.getElementById("statusBtnSpinner");
    const text = document.getElementById("statusBtnText");

    btn.disabled = false;
    spinner.classList.add("hidden");
    text.textContent = "บันทึก";

    if (!response.success) {
      showToast(response.message, "error");
      return;
    }

    showToast("อัพเดทสถานะสำเร็จ!", "success");

    if (response.data.documentUrl) {
      setTimeout(() => {
        showToast(
          `สร้างเอกสารสำเร็จ! <a href="${response.data.documentUrl}" target="_blank" class="underline ml-2">คลิกเพื่อดู</a>`,
          "success"
        );
      }, 1000);
    }

    closeUpdateStatusModal();
    closeViewPaymentModal();

    // Reload payments
    setTimeout(() => {
      loadPayments();
    }, 1500);
  }

  // Utility Functions
  function showPaymentLoading() {
    const tbody = document.getElementById("paymentTableBody");
    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="px-6 py-12 text-center text-gray-400">
          <div class="flex flex-col items-center space-y-3">
            <div class="w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
            <span>กำลังดึงข้อมูล...</span>
          </div>
        </td>
      </tr>
    `;
  }

  function hidePaymentLoading() {
    // Loading will be replaced by actual data
  }

  function onPaymentError(error) {
    console.error("Error:", error);
    showToast("เกิดข้อผิดพลาด: " + error.message, "error");
    hidePaymentLoading();
  }
</script>
