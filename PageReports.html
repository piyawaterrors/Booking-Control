<!-- Reports Page -->
<div class="space-y-6">
  <!-- Page Header & Filter -->
  <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6">
    <!-- Dynamic Header & Filters Row -->
    <div
      class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"
    >
      <!-- Left side: Title -->
      <div>
        <h3 class="text-lg font-bold text-gray-800">รายงานและสถิติ</h3>
        <p class="text-sm text-gray-500 mt-1">วิเคราะห์ยอดขายและสรุปข้อมูล</p>
      </div>

      <!-- Right side: All Filter Controls -->
      <div class="flex flex-col lg:flex-row lg:items-center gap-4">
        <!-- Part 1: Quick Filter Buttons -->
        <div
          class="grid grid-cols-2 sm:grid-cols-4 lg:flex lg:flex-row gap-2 order-2 lg:order-1"
        >
          <button
            onclick="setReportFilter('all')"
            class="px-3 py-2 bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            ทั้งหมด
          </button>
          <button
            onclick="setReportFilter('today')"
            class="px-3 py-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            วันนี้
          </button>
          <button
            onclick="setReportFilter('month')"
            class="px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            เดือนนี้
          </button>
          <button
            onclick="setReportFilter('year')"
            class="px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            ปีนี้
          </button>
        </div>

        <!-- Part 2: Separator / Label -->
        <div class="hidden lg:block w-px h-8 bg-gray-200 order-2"></div>
        <div class="lg:hidden order-3 border-t border-gray-100 pt-4 mt-2">
          <label
            class="text-xs text-gray-500 uppercase tracking-wide mb-2 block"
            >กำหนดช่วงเวลาเอง</label
          >
        </div>

        <!-- Part 3: Date Inputs -->
        <div
          class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 order-3 lg:order-3"
        >
          <input
            type="date"
            id="reportStartDate"
            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 text-sm input-modern lg:w-40"
            placeholder="จาก"
          />
          <span class="hidden sm:inline text-gray-400">-</span>
          <input
            type="date"
            id="reportEndDate"
            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 text-sm input-modern lg:w-40"
            placeholder="ถึง"
          />
          <button
            onclick="applyCustomReportFilter()"
            class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-medium text-sm whitespace-nowrap"
          >
            ค้นหา
          </button>
        </div>
      </div>
    </div>

    <!-- Current Filter Display -->
    <div class="mt-4 pt-4 border-t border-gray-100">
      <p class="text-sm text-gray-600">
        <span class="font-semibold">ช่วงเวลาที่เลือก:</span>
        <span id="reportFilterText" class="text-purple-600 ml-2">เดือนนี้</span>
      </p>
    </div>
  </div>

  <!-- Reports Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 1. Daily Sales by Location -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-lg font-bold text-gray-800">
            ยอดขายรายวันตามสถานที่
          </h3>
          <p class="text-xs text-gray-500 mt-1">
            รวมรายการที่เคยเป็น Completed
          </p>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <select
              id="sortDailySales"
              onchange="sortAndRenderDailySales()"
              class="input-modern select-modern w-full sm:w-auto"
            >
              <option value="sales">เรียงตามยอดขาย</option>
              <option value="count">เรียงตามยอดการจอง</option>
            </select>
            <button
              onclick="exportDailySalesToExcel()"
              class="px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all font-medium text-sm flex items-center gap-2"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
              Export Excel
            </button>
          </div>
        </div>
        <div
          class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
            ></path>
          </svg>
        </div>
      </div>

      <!-- Loading State -->
      <div id="dailySalesLoading" class="space-y-4">
        <!-- Summary Skeleton -->
        <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
          <div class="h-4 bg-gray-200 rounded w-32 mb-2"></div>
          <div class="h-8 bg-gray-300 rounded w-40"></div>
        </div>

        <!-- Item Skeletons -->
        <div class="space-y-3">
          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-32 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-24"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>

          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-28 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-20"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>

          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-36 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-28"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>
        </div>
      </div>

      <!-- Data Container -->
      <div id="dailySalesContainer" class="hidden space-y-4"></div>
    </div>

    <!-- 2. Program Summary -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-lg font-bold text-gray-800">สรุปยอดแต่ละโปรแกรม</h3>
          <p class="text-xs text-gray-500 mt-1">
            รวมรายการที่เคยเป็น Completed
          </p>
          <div class="mt-2">
            <select
              id="sortProgramSummary"
              onchange="sortAndRenderProgramSummary()"
              class="input-modern select-modern w-full sm:w-auto"
            >
              <option value="sales">เรียงตามยอดขาย</option>
              <option value="count">เรียงตามยอดการจอง</option>
            </select>
          </div>
        </div>
        <div
          class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
            ></path>
          </svg>
        </div>
      </div>

      <!-- Loading State -->
      <div id="programSummaryLoading" class="space-y-4">
        <!-- Summary Skeleton -->
        <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
          <div class="h-4 bg-gray-200 rounded w-24 mb-2"></div>
          <div class="h-8 bg-gray-300 rounded w-40"></div>
        </div>

        <!-- Item Skeletons -->
        <div class="space-y-3">
          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-40 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-48"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>

          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-36 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-44"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>

          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-44 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-52"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>
        </div>
      </div>

      <!-- Data Container -->
      <div id="programSummaryContainer" class="hidden space-y-4"></div>
    </div>
  </div>
</div>

<script>
  // Global state
  var currentReportFilter = {
    type: "month",
    startDate: null,
    endDate: null,
  };
  window.dailySalesData = [];
  window.programSummaryData = [];

  /**
   * Page Initialization
   */
  function loadReports(startDate, endDate) {
    const session = getSessionFromStorage();
    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    // Default to this month if parameters are undefined
    if (startDate === undefined || endDate === undefined) {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      startDate = formatDateForInput(firstDay);
      endDate = formatDateForInput(lastDay);

      document.getElementById("reportStartDate").value = startDate;
      document.getElementById("reportEndDate").value = endDate;
    }

    showReportLoading(true);

    // Load both reports in parallel
    Promise.all([
      new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getDailySalesReport(session.sessionToken, startDate, endDate);
      }),
      new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getProgramSummaryReport(session.sessionToken, startDate, endDate);
      }),
    ])
      .then(([dailySalesResponse, programSummaryResponse]) => {
        showReportLoading(false);

        if (dailySalesResponse.success) {
          window.dailySalesData = dailySalesResponse.data.dailySales || [];
          sortAndRenderDailySales();
        } else {
          showToast(dailySalesResponse.message, "error");
        }

        if (programSummaryResponse.success) {
          window.programSummaryData =
            programSummaryResponse.data.programSummary || [];
          sortAndRenderProgramSummary();
        } else {
          showToast(programSummaryResponse.message, "error");
        }
      })
      .catch((error) => {
        showToast("เกิดข้อผิดพลาด: " + error.message, "error");
        showReportLoading(false);
      });
  }

  /**
   * Set Report Filter (Quick Filters)
   */
  function setReportFilter(type) {
    const today = new Date();
    let startDate, endDate, filterText;

    switch (type) {
      case "all":
        startDate = "";
        endDate = "";
        filterText = "ทั้งหมด";
        break;
      case "today":
        startDate = endDate = formatDateForInput(today);
        filterText = "วันนี้";
        break;
      case "month":
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        startDate = formatDateForInput(firstDay);
        endDate = formatDateForInput(lastDay);
        filterText = "เดือนนี้";
        break;
      case "year":
        const yearStart = new Date(today.getFullYear(), 0, 1);
        const yearEnd = new Date(today.getFullYear(), 11, 31);
        startDate = formatDateForInput(yearStart);
        endDate = formatDateForInput(yearEnd);
        filterText = "ปีนี้";
        break;
    }

    document.getElementById("reportStartDate").value = startDate;
    document.getElementById("reportEndDate").value = endDate;
    document.getElementById("reportFilterText").textContent = filterText;

    currentReportFilter = { type, startDate, endDate };
    loadReports(startDate, endDate);
  }

  /**
   * Apply Custom Date Filter
   */
  function applyCustomReportFilter() {
    const startDate = document.getElementById("reportStartDate").value;
    const endDate = document.getElementById("reportEndDate").value;

    if (!startDate || !endDate) {
      showToast("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด", "warning");
      return;
    }

    if (new Date(startDate) > new Date(endDate)) {
      showToast("วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด", "error");
      return;
    }

    document.getElementById("reportFilterText").textContent = `${formatDate(
      startDate,
    )} - ${formatDate(endDate)}`;

    currentReportFilter = { type: "custom", startDate, endDate };
    loadReports(startDate, endDate);
  }

  /**
   * Sort and Render Functions
   */
  function sortAndRenderDailySales() {
    const sortBy = document.getElementById("sortDailySales").value;
    const data = [...(window.dailySalesData || [])].sort((a, b) => {
      const valA = sortBy === "sales" ? a.totalSales || 0 : a.bookingCount || 0;
      const valB = sortBy === "sales" ? b.totalSales || 0 : b.bookingCount || 0;
      return valB !== valA
        ? valB - valA
        : (a.location || "").localeCompare(b.location || "");
    });
    renderDailySales(data);
  }

  function sortAndRenderProgramSummary() {
    const sortBy = document.getElementById("sortProgramSummary").value;
    const data = [...(window.programSummaryData || [])].sort((a, b) => {
      const valA =
        sortBy === "sales" ? a.totalRevenue || 0 : a.bookingCount || 0;
      const valB =
        sortBy === "sales" ? b.totalRevenue || 0 : b.bookingCount || 0;
      return valB !== valA
        ? valB - valA
        : (a.program || "").localeCompare(b.program || "");
    });
    renderProgramSummary(data);
  }

  /**
   * UI Rendering
   */
  function showReportLoading(isLoading) {
    const dailyLoading = document.getElementById("dailySalesLoading");
    const dailyContainer = document.getElementById("dailySalesContainer");
    const progLoading = document.getElementById("programSummaryLoading");
    const progContainer = document.getElementById("programSummaryContainer");

    if (isLoading) {
      dailyLoading.classList.remove("hidden");
      dailyContainer.classList.add("hidden");
      progLoading.classList.remove("hidden");
      progContainer.classList.add("hidden");
    } else {
      dailyLoading.classList.add("hidden");
      progLoading.classList.add("hidden");
    }
  }

  function renderDailySales(data) {
    const container = document.getElementById("dailySalesContainer");
    container.classList.remove("hidden");

    if (!data || data.length === 0) {
      container.innerHTML = `<div class="text-center py-8 text-gray-400"><p class="text-sm">ไม่มีข้อมูลในช่วงเวลาที่เลือก</p></div>`;
      return;
    }

    const total = data.reduce((sum, item) => sum + item.totalSales, 0);

    container.innerHTML = `
      <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
        <div class="text-sm text-gray-600 mb-1">ยอดขายรวมทั้งหมด</div>
        <div class="text-3xl font-bold text-blue-600">฿${total.toLocaleString()}</div>
      </div>
      ${data
        .map((item, index) => {
          const percentage = total > 0 ? (item.totalSales / total) * 100 : 0;
          const color = [
            "from-blue-500 to-cyan-600",
            "from-purple-500 to-pink-600",
            "from-green-500 to-emerald-600",
            "from-orange-500 to-red-600",
            "from-indigo-500 to-purple-600",
          ][index % 5];
          return `
          <div class="bg-gray-50 rounded-xl p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="font-bold text-gray-800 mb-1">${
                  item.location || "ไม่ระบุ"
                }</div>
                <div class="flex flex-wrap items-center gap-y-1 gap-x-4 text-[10px] text-gray-500">
                  <span>ผู้ใหญ่ ${item.totalAdults}</span>
                  <span>เด็ก ${item.totalChildren}</span>
                  <span>FOC ${item.totalFoc || 0}</span>
                  <span>รายการจอง ${item.bookingCount}</span>
                </div>
              </div>
              <div class="text-right ml-4">
                <div class="text-lg font-bold text-gray-900">฿${item.totalSales.toLocaleString()}</div>
                <div class="text-[10px] text-gray-500">${percentage.toFixed(
                  1,
                )}%</div>
              </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5">
              <div class="bg-gradient-to-r ${color} h-1.5 rounded-full" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
        })
        .join("")}
    `;
  }

  function renderProgramSummary(data) {
    const container = document.getElementById("programSummaryContainer");
    container.classList.remove("hidden");

    if (!data || data.length === 0) {
      container.innerHTML = `<div class="text-center py-8 text-gray-400"><p class="text-sm">ไม่มีข้อมูลในช่วงเวลาที่เลือก</p></div>`;
      return;
    }

    const totalRevenue = data.reduce((sum, item) => sum + item.totalRevenue, 0);

    container.innerHTML = `
      <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-4 mb-4">
        <div class="text-sm text-gray-600 mb-1">รายได้รวม</div>
        <div class="text-3xl font-bold text-purple-600">฿${totalRevenue.toLocaleString()}</div>
      </div>
      ${data
        .map((item, index) => {
          const percentage =
            totalRevenue > 0 ? (item.totalRevenue / totalRevenue) * 100 : 0;
          return `
          <div class="bg-gray-50 rounded-xl p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="font-bold text-gray-800 mb-1">${
                  item.program || "ไม่ระบุ"
                }</div>
                <div class="flex items-center gap-4 text-[10px] text-gray-500">
                  <span>ผู้ใหญ่ ${item.totalAdults}</span>
                  <span>เด็ก ${item.totalChildren}</span>
                  <span>FOC ${item.totalFoc || 0}</span>
                  <span>จอง ${item.bookingCount}</span>
                </div>
              </div>
              <div class="text-right ml-4">
                <div class="text-lg font-bold text-gray-900">฿${item.totalRevenue.toLocaleString()}</div>
                <div class="text-[10px] text-gray-500">${percentage.toFixed(
                  1,
                )}%</div>
              </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-1.5">
              <div class="bg-gradient-to-r from-purple-500 to-pink-600 h-1.5 rounded-full" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
        })
        .join("")}
    `;
  }

  /**
   * Export Functions
   */
  function exportDailySalesToExcel() {
    const data = window.dailySalesData || [];
    if (data.length === 0)
      return showToast("ไม่มีข้อมูลสำหรับส่งออก", "warning");

    let csvContent = "\uFEFF";
    csvContent += "สถานที่,ผู้ใหญ่,เด็ก,FOC,รวมทั้งหมด,รายการจอง,ยอดขาย\n";

    data.forEach((item) => {
      const location = (item.location || "ไม่ระบุ").replace(/,/g, " ");
      csvContent += `${location},${item.totalAdults},${item.totalChildren},${
        item.totalFoc || 0
      },${item.totalAdults + item.totalChildren + (item.totalFoc || 0)},${
        item.bookingCount
      },${item.totalSales}\n`;
    });

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    const filterText =
      document.getElementById("reportFilterText").textContent || "report";

    link.href = url;
    link.download = `รายงานยอดขายตามสถานที่_${filterText.replace(
      /[\/\\\s-]/g,
      "_",
    )}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    showToast("ส่งออกข้อมูลเรียบร้อยแล้ว", "success");
  }

  // Export to window
  window.loadReports = loadReports;
  window.setReportFilter = setReportFilter;
  window.applyCustomReportFilter = applyCustomReportFilter;
  window.sortAndRenderDailySales = sortAndRenderDailySales;
  window.sortAndRenderProgramSummary = sortAndRenderProgramSummary;
  window.exportDailySalesToExcel = exportDailySalesToExcel;
</script>
