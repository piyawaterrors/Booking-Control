<!-- Employee Management Page - Modern UI -->
<div class="space-y-6">
  <!-- Header Actions -->
  <div
    class="flex flex-col lg:flex-row justify-between items-stretch lg:items-center gap-4"
  >
    <!-- Search and Filters -->
    <div class="w-full lg:w-auto lg:flex-1">
      <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:flex lg:flex-row gap-3 lg:items-center"
      >
        <!-- Refresh & Search Group -->
        <div class="flex flex-row gap-2 sm:col-span-2 lg:flex-1">
          <!-- Refresh Button -->
          <button
            onclick="refreshEmployeesData()"
            class="flex-shrink-0 flex items-center justify-center p-3 bg-white border-2 border-gray-100 rounded-xl text-gray-500 hover:text-purple-600 hover:border-purple-100 hover:bg-purple-50 transition-all duration-200 shadow-sm"
            title="รีเฟรชข้อมูล"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
          </button>

          <!-- Search -->
          <div class="relative flex-1 lg:w-64">
            <input
              type="text"
              id="employeeSearchInput"
              placeholder="ค้นหาพนักงาน..."
              onkeyup="filterEmployees()"
              class="w-full input-modern pl-10"
            />
            <svg
              class="w-5 h-5 text-gray-400 absolute left-3 top-3.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              ></path>
            </svg>
          </div>
        </div>

        <!-- Filter by Role -->
        <select
          id="employeeFilterRole"
          onchange="filterEmployees()"
          class="w-full lg:w-44 input-modern select-modern"
        >
          <option value="">ทุกตำแหน่ง</option>
          <option value="OP">OP</option>
          <option value="Admin">Admin</option>
          <option value="AR_AP">AR/AP</option>
          <option value="Cost">Cost</option>
          <option value="Owner">Owner</option>
        </select>

        <!-- Filter by Status -->
        <select
          id="employeeFilterStatus"
          onchange="filterEmployees()"
          class="w-full lg:w-44 input-modern select-modern"
        >
          <option value="">ทุกสถานะ</option>
          <option value="เปิดใช้งาน">เปิดใช้งาน</option>
          <option value="ปิดใช้งาน">ปิดใช้งาน</option>
        </select>
      </div>
    </div>

    <!-- Add Employee Button -->
    <button
      onclick="openAddEmployeeModal()"
      class="w-full md:w-auto bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:shadow-xl hover:scale-[1.02] active:scale-95 transition-all duration-200 flex items-center justify-center space-x-2 font-semibold shadow-lg shadow-purple-200"
    >
      <svg
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 4v16m8-8H4"
        ></path>
      </svg>
      <span>เพิ่มพนักงาน</span>
    </button>
  </div>

  <!-- Employee Table Container (Desktop) -->
  <div
    class="hidden lg:block bg-white rounded-2xl shadow-xl shadow-gray-100 overflow-hidden border border-gray-100"
  >
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gray-50 border-b border-gray-100">
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            รหัสผู้ใช้
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            ชื่อ-นามสกุล
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            ชื่อผู้ใช้
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            เบอร์โทร
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            อีเมล
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            ตำแหน่ง
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สถานะ
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            จัดการ
          </th>
        </tr>
      </thead>
      <tbody id="employeeTableBody" class="divide-y divide-gray-100">
        <tr>
          <td colspan="7" class="px-6 py-12 text-center text-gray-400">
            <div class="flex flex-col items-center space-y-3">
              <div
                class="w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"
              ></div>
              <span>กำลังดึงข้อมูลพนักงาน...</span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Employee List Container (Mobile/Tablet) -->
  <div
    id="employeeGridBody"
    class="lg:hidden grid grid-cols-1 md:grid-cols-2 gap-4"
  >
    <!-- Mobile cards will be rendered here -->
  </div>

  <!-- Pagination Controls -->
  <div
    class="flex flex-col sm:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100 gap-4 mt-4"
  >
    <!-- Rows per page -->
    <div class="flex items-center space-x-3 text-sm text-gray-600">
      <span class="font-medium">แสดง</span>
      <select
        id="empItemsPerPageSelect"
        onchange="changeEmpPageSize()"
        class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all cursor-pointer font-bold text-gray-700"
      >
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span class="font-medium">รายการต่อหน้า</span>
    </div>

    <!-- Page Info & Navigation -->
    <div class="flex flex-col sm:flex-row items-center gap-4">
      <span
        class="hidden sm:inline text-sm font-medium text-gray-500"
        id="empPaginationInfo"
        >หน้า 1 จาก 1 (0 รายการ)</span
      >
      <div class="flex items-center space-x-1">
        <button
          onclick="changeEmpPage('prev')"
          id="empPrevPageBtn"
          class="p-4 sm:p-2 border border-gray-200 rounded-xl sm:rounded-lg hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
        >
          <svg
            class="w-6 h-6 sm:w-5 sm:h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            ></path>
          </svg>
        </button>

        <!-- Desktop Page Numbers -->
        <div id="empPageNumbers" class="hidden sm:flex items-center space-x-1">
          <!-- Page buttons will be injected here -->
        </div>

        <!-- Mobile Page Info -->
        <div
          class="sm:hidden flex items-center px-6 py-2 bg-purple-50 rounded-xl text-sm font-bold text-purple-700 min-w-[100px] justify-center"
        >
          <span id="empMobilePageInfo">1 / 1</span>
        </div>

        <button
          onclick="changeEmpPage('next')"
          id="empNextPageBtn"
          class="p-4 sm:p-2 border border-gray-200 rounded-xl sm:rounded-lg hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
        >
          <svg
            class="w-6 h-6 sm:w-5 sm:h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div
    id="emptyState"
    class="hidden text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-100"
  >
    <div
      class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <svg
        class="w-10 h-10 text-gray-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
        ></path>
      </svg>
    </div>
    <h3 class="text-lg font-bold text-gray-900">ไม่พบข้อมูลพนักงาน</h3>
    <p class="text-gray-500">ลองเปลี่ยนเงื่อนไขการค้นหาหรือเพิ่มพนักงานใหม่</p>
  </div>
</div>

<!-- Add/Edit Employee Modal -->
<div
  id="employeeModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm"
>
  <div
    id="employeeModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden"
  >
    <!-- Header with Close Button -->
    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6 relative">
      <h3 class="text-2xl font-bold text-white" id="employeeModalTitle">
        เพิ่มพนักงานใหม่
      </h3>
      <button
        type="button"
        onclick="closeEmployeeModal()"
        class="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all duration-200"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Form Content -->
    <div class="overflow-y-auto max-h-[calc(90vh-180px)]">
      <form id="employeeForm" class="p-6 space-y-4">
        <input type="hidden" id="employeeId" />

        <!-- Full Name -->
        <div class="transition-all duration-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            ชื่อ-นามสกุล <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="fullName"
            required
            class="input-modern"
            placeholder="กรอกชื่อ-นามสกุล"
          />
        </div>

        <!-- Phone -->
        <div class="transition-all duration-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            เบอร์โทรศัพท์ <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="phone"
            class="input-modern"
            placeholder="0XXXXXXXX"
            pattern="[0-9]*"
            inputmode="tel"
            maxlength="10"
            required
          />
        </div>

        <!-- Email -->
        <div class="transition-all duration-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            อีเมล <span class="text-red-500">*</span>
          </label>
          <input
            type="email"
            id="email"
            required
            class="input-modern"
            placeholder="example@email.com"
          />
        </div>

        <!-- Username -->
        <div class="transition-all duration-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            ชื่อผู้ใช้ <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="username"
            required
            class="input-modern"
            placeholder="กรอกชื่อผู้ใช้"
          />
        </div>

        <!-- Role -->
        <div class="transition-all duration-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            ตำแหน่ง <span class="text-red-500">*</span>
          </label>
          <select id="role" required class="input-modern select-modern">
            <option value="">เลือกตำแหน่ง</option>
            <option value="OP">OP</option>
            <option value="Admin">Admin</option>
            <option value="AR_AP">AR/AP</option>
            <option value="Cost">Cost</option>
            <option value="Owner">Owner</option>
          </select>
        </div>

        <!-- Status (for edit mode) -->
        <div id="statusField" class="hidden transition-all duration-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            สถานะ <span class="text-red-500">*</span>
          </label>
          <select id="status" class="input-modern select-modern">
            <option value="เปิดใช้งาน">เปิดใช้งาน</option>
            <option value="ปิดใช้งาน">ปิดใช้งาน</option>
          </select>
        </div>

        <!-- Password Info -->
        <div
          class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4"
        >
          <div class="flex items-start space-x-3">
            <svg
              class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <p class="text-sm text-blue-800">
              <strong>หมายเหตุ:</strong> รหัสผ่านเริ่มต้นคือ
              <span class="bg-blue-100 px-2 py-1 rounded">เบอร์โทรศัพท์</span>
            </p>
          </div>
        </div>
      </form>
    </div>

    <!-- Action Buttons -->
    <div
      class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 border-t border-gray-200"
    >
      <button
        type="button"
        id="cancelEmployeeBtn"
        onclick="closeEmployeeModal()"
        class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-medium"
      >
        ยกเลิก
      </button>
      <button
        type="submit"
        form="employeeForm"
        id="submitEmployeeBtn"
        class="px-6 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl hover:shadow-lg active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed transition-all duration-0.05 font-medium flex items-center space-x-2"
      >
        <span
          id="submitBtnSpinner"
          class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
        ></span>
        <span id="submitBtnText">บันทึก</span>
      </button>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div
  id="resetPasswordModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm"
>
  <div
    id="resetPasswordModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4"
  >
    <!-- Header with Close Button -->
    <div
      class="bg-gradient-to-r from-orange-500 to-red-600 p-6 relative rounded-t-2xl"
    >
      <h3 class="text-xl font-bold text-white">รีเซ็ตรหัสผ่าน</h3>
      <button
        type="button"
        onclick="closeResetPasswordModal()"
        class="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all duration-200"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <div class="p-6">
      <p class="text-gray-600 mb-4">
        คุณต้องการรีเซ็ตรหัสผ่านของ
        <strong id="resetEmployeeName" class="text-gray-900"></strong> หรือไม่?
      </p>
      <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4">
        <p class="text-sm text-yellow-800">
          รหัสผ่านจะถูกรีเซ็ตเป็น
          <span class="bg-yellow-100 px-2 py-1 rounded">เบอร์โทรศัพท์</span>
          ของพนักงานท่านนี้
        </p>
      </div>

      <input type="hidden" id="resetEmployeeId" />

      <div class="flex justify-end space-x-3 mt-6">
        <button
          type="button"
          id="cancelResetBtn"
          onclick="closeResetPasswordModal()"
          class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-medium"
        >
          ยกเลิก
        </button>
        <button
          type="button"
          id="confirmResetBtn"
          onclick="confirmResetPassword()"
          class="px-6 py-2.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:shadow-lg hover:scale-105 active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed transition-all duration-200 font-medium flex items-center space-x-2"
        >
          <span
            id="resetSpinner"
            class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
          ></span>
          <span id="resetBtnText">รีเซ็ตรหัสผ่าน</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  id="deleteEmployeeModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity duration-300"
>
  <div
    id="deleteEmployeeModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden transform transition-all scale-95 opacity-0"
  >
    <div class="bg-red-50 p-6 flex items-center space-x-4">
      <div
        class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0"
      >
        <svg
          class="w-6 h-6 text-red-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          ></path>
        </svg>
      </div>
      <div>
        <h3 class="text-xl font-bold text-gray-900">ยืนยันการลบพนักงาน</h3>
        <p class="text-sm text-gray-500">การกระทำนี้ไม่สามารถย้อนคืนได้</p>
      </div>
    </div>

    <div class="p-6">
      <p class="text-gray-600 mb-6 text-center">
        คุณต้องการลบพนักงาน
        <strong id="deleteEmployeeName" class="text-gray-900 text-lg"></strong>
        หรือไม่?
      </p>

      <input type="hidden" id="deleteEmployeeId" />

      <div class="flex space-x-3">
        <button
          type="button"
          id="cancelDeleteBtn"
          onclick="closeDeleteModal()"
          class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-medium"
        >
          ยกเลิก
        </button>
        <button
          type="button"
          id="confirmDeleteBtn"
          onclick="confirmDeleteEmployee()"
          class="flex-1 px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 hover:shadow-lg shadow-red-100 active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed transition-all duration-0.05 font-bold flex items-center justify-center space-x-2"
        >
          <span
            id="deleteBtnSpinner"
            class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
          ></span>
          <span id="deleteBtnText">ลบข้อมูล</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  var allEmployeesList = [];
  var empFilteredList = [];
  var employeeEditId = null;
  var empCurrentPage = 1;
  var empItemsPerPage = 10;

  /**
   * Toggle Loading Helper
   */
  function toggleEmployeeLoading(
    btnId,
    spinnerId,
    textId,
    isLoading,
    defaultText,
    loadingText,
  ) {
    AppUI.toggleLoading(
      btnId,
      spinnerId,
      textId,
      isLoading,
      defaultText,
      loadingText,
    );
    const cancelBtnId =
      btnId === "submitEmployeeBtn"
        ? "cancelEmployeeBtn"
        : btnId === "confirmDeleteBtn"
          ? "cancelDeleteBtn"
          : btnId === "confirmResetBtn"
            ? "cancelResetBtn"
            : null;
    const cancelBtn = cancelBtnId ? document.getElementById(cancelBtnId) : null;
    if (cancelBtn) cancelBtn.disabled = isLoading;
  }

  /**
   * Refresh Employees Data
   */
  function refreshEmployeesData() {
    document.getElementById("employeeSearchInput").value = "";
    document.getElementById("employeeFilterRole").value = "";
    document.getElementById("employeeFilterStatus").value = "";
    loadEmployees();
  }

  /**
   * Load Employees
   */
  function loadEmployees() {
    const session = getSessionFromStorage();

    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    const tbody = document.getElementById("employeeTableBody");
    const gbody = document.getElementById("employeeGridBody");

    // Show Loading state
    const loadingHtml = `
      <tr>
        <td colspan="7" class="px-6 py-12 text-center">
          <div class="flex flex-col items-center justify-center space-y-3">
            <div class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"></div>
            <p class="text-gray-400 text-sm font-medium animate-pulse">กำลังดึงข้อมูลพนักงาน...</p>
          </div>
        </td>
      </tr>
    `;
    const gridLoadingHtml = `
      <div class="col-span-full py-12 text-center">
        <div class="flex flex-col items-center justify-center space-y-3">
          <div class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"></div>
          <p class="text-gray-400 text-sm font-medium animate-pulse">กำลังดึงข้อมูลพนักงาน...</p>
        </div>
      </div>
    `;

    if (tbody) tbody.innerHTML = loadingHtml;
    if (gbody) gbody.innerHTML = gridLoadingHtml;

    google.script.run
      .withSuccessHandler(function (response) {
        if (response && response.success) {
          allEmployeesList = response.data || [];
          filterEmployees(); // Use filterEmployees to respect current (or reset) filters
        } else {
          const errorMsg = response
            ? response.message
            : "ไม่สามารถดึงข้อมูลได้";
          showToast(errorMsg, "error");

          if (tbody)
            tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-red-500">${errorMsg}</td></tr>`;
        }
      })
      .withFailureHandler(function (error) {
        showToast("เกิดข้อผิดพลาด: " + error.message, "error");
        if (tbody)
          tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-red-500">เกิดข้อผิดพลาด: ${error.message}</td></tr>`;
      })
      .getAllUsers(session.sessionToken);
  }

  function renderEmployees(employees) {
    const tbody = document.getElementById("employeeTableBody");
    const gbody = document.getElementById("employeeGridBody");
    const emptyState = document.getElementById("emptyState");

    const totalItems = employees.length;

    // Use Shared Pagination
    const paginatedItems = AppPagination.getPaginatedItems(
      employees,
      empCurrentPage,
      empItemsPerPage,
    );

    AppPagination.render({
      currentPage: empCurrentPage,
      itemsPerPage: empItemsPerPage,
      totalItems: totalItems,
      onPageChange: "goToEmpPage",
      containerIds: {
        info: "empPaginationInfo",
        mobile: "empMobilePageInfo",
        prev: "empPrevPageBtn",
        next: "empNextPageBtn",
        numbers: "empPageNumbers",
      },
    });

    if (totalItems === 0) {
      if (tbody)
        tbody.innerHTML =
          '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-400">ไม่พบข้อมูล</td></tr>';
      if (gbody) gbody.innerHTML = "";
      emptyState.classList.remove("hidden");
      return;
    }

    emptyState.classList.add("hidden");

    // Desktop Table
    if (tbody) {
      tbody.innerHTML = paginatedItems
        .map(
          (emp) => `
        <tr class="group hover:bg-purple-50/50 transition-all duration-200">
          <td class="px-6 py-4 text-sm font-semibold text-gray-700">${
            emp.userId
          }</td>
          <td class="px-6 py-4">
            <div class="flex items-center">
              <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold mr-3 shadow-sm">
                ${emp.fullName.charAt(0)}
              </div>
              <span class="text-sm font-bold text-gray-900">${
                emp.fullName
              }</span>
            </div>
          </td>
          <td class="px-6 py-4 text-sm text-gray-600 font-medium">${
            emp.username
          }</td>
          <td class="px-6 py-4 text-sm font-mono text-indigo-600 font-medium">${
            emp.phone || "-"
          }</td>
          <td class="px-6 py-4 text-sm text-gray-500">${emp.email}</td>
          <td class="px-6 py-4">
            <span class="px-3 py-1 text-xs font-bold rounded-lg border-2 ${getRoleBadgeClass(
              emp.role,
            )}">${emp.role}</span>
          </td>
          <td class="px-6 py-4 text-center">
            <button onclick="toggleUserStatus('${
              emp.userId
            }')" class="group relative inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold transition-all ${
              emp.status === "เปิดใช้งาน"
                ? "bg-green-100 text-green-700 hover:bg-green-200"
                : "bg-red-100 text-red-700 hover:bg-red-200"
            }">
              <span class="w-1.5 h-1.5 rounded-full mr-1.5 ${
                emp.status === "เปิดใช้งาน" ? "bg-green-500" : "bg-red-500"
              }"></span>
              ${emp.status}
            </button>
          </td>
          <td class="px-6 py-4 text-center">
            <div class="flex justify-center items-center space-x-1">
              <button onclick="editEmployee('${
                emp.userId
              }')" class="p-2 text-indigo-600 hover:bg-indigo-50 border border-transparent hover:border-indigo-100 rounded-xl transition-all shadow-sm bg-white" title="แก้ไข">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
              </button>
              <button onclick="openResetPasswordModal('${emp.userId}', '${
                emp.fullName
              }')" class="p-2 text-orange-600 hover:bg-orange-50 border border-transparent hover:border-orange-100 rounded-xl transition-all shadow-sm bg-white" title="รีเซ็ตรหัสผ่าน">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
              </button>
              <button onclick="deleteEmployeeModal('${emp.userId}', '${
                emp.fullName
              }')" class="p-2 text-red-600 hover:bg-red-50 border border-transparent hover:border-red-100 rounded-xl transition-all shadow-sm bg-white" title="ลบ">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </div>
          </td>
        </tr>
      `,
        )
        .join("");
    }

    // Mobile Grid
    if (gbody) {
      gbody.innerHTML = paginatedItems
        .map(
          (emp) => `
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-all relative overflow-hidden">
          <div class="flex justify-between items-start mb-4">
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center text-white font-bold mr-3 shadow-sm">${emp.fullName.charAt(
                0,
              )}</div>
              <div>
                <h4 class="font-bold text-gray-900">${emp.fullName}</h4>
                <p class="text-xs text-gray-500">${emp.userId}</p>
              </div>
            </div>
            <span class="px-2 py-1 text-[10px] font-bold rounded-lg border-2 ${getRoleBadgeClass(
              emp.role,
            )}">${emp.role}</span>
          </div>
          <div class="space-y-2 mb-4">
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">Username</span>
              <span class="text-gray-900 font-medium">${emp.username}</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">เบอร์โทร</span>
              <span class="text-indigo-600 font-bold">${emp.phone || "-"}</span>
            </div>
            <div class="flex justify-between text-xs">
              <span class="text-gray-400">สถานะ</span>
              <span class="font-bold ${
                emp.status === "เปิดใช้งาน" ? "text-green-600" : "text-red-600"
              }">${emp.status}</span>
            </div>
          </div>
          <div class="flex space-x-2">
            <button onclick="editEmployee('${
              emp.userId
            }')" class="flex-1 py-2 bg-indigo-50 text-indigo-700 rounded-xl text-sm font-bold">แก้ไข</button>
            <button onclick="openResetPasswordModal('${emp.userId}', '${
              emp.fullName
            }')" class="px-3 py-2 bg-orange-50 text-orange-600 rounded-xl text-sm font-bold">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
            </button>
            <button onclick="deleteEmployeeModal('${emp.userId}', '${
              emp.fullName
            }')" class="px-3 py-2 bg-red-50 text-red-600 rounded-xl text-sm font-bold">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </div>
        </div>
      `,
        )
        .join("");
    }
  }

  /**
   * Get Role Badge Class
   */
  function getRoleBadgeClass(role) {
    const classes = {
      Sale: "bg-blue-50 border-blue-100 text-blue-700",
      OP: "bg-emerald-50 border-emerald-100 text-emerald-700",
      Admin: "bg-purple-50 border-purple-100 text-purple-700",
      AR_AP: "bg-amber-50 border-amber-100 text-amber-700",
      Cost: "bg-orange-50 border-orange-100 text-orange-700",
      Owner: "bg-rose-50 border-rose-100 text-rose-700",
    };
    return classes[role] || "bg-gray-50 border-gray-100 text-gray-700";
  }

  /**
   * Filter Employees
   */
  function filterEmployees() {
    const searchTerm = document
      .getElementById("employeeSearchInput")
      .value.toLowerCase();
    const roleFilter = document.getElementById("employeeFilterRole").value;
    const statusFilter = document.getElementById("employeeFilterStatus").value;

    empFilteredList = allEmployeesList.filter((emp) => {
      const matchSearch =
        emp.fullName.toLowerCase().includes(searchTerm) ||
        emp.username.toLowerCase().includes(searchTerm) ||
        emp.email.toLowerCase().includes(searchTerm);

      const matchRole = !roleFilter || emp.role === roleFilter;
      const matchStatus = !statusFilter || emp.status === statusFilter;

      return matchSearch && matchRole && matchStatus;
    });

    empCurrentPage = 1;
    renderEmployees(empFilteredList);
  }

  /**
   * Open Add Employee Modal with Animation
   */
  function openAddEmployeeModal() {
    employeeEditId = null;
    document.getElementById("employeeModalTitle").textContent =
      "เพิ่มพนักงานใหม่";
    document.getElementById("employeeForm").reset();

    // Enable all fields for new employee
    document.getElementById("fullName").disabled = false;
    document.getElementById("phone").disabled = false;
    document.getElementById("email").disabled = false;
    document.getElementById("username").disabled = false;

    document.getElementById("statusField").classList.add("hidden");

    const modal = document.getElementById("employeeModal");
    const modalContent = document.getElementById("employeeModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  /**
   * Edit Employee
   */
  function editEmployee(userId) {
    const employee = allEmployeesList.find((emp) => emp.userId === userId);
    if (!employee) return;

    employeeEditId = userId;
    document.getElementById("employeeModalTitle").textContent =
      "แก้ไขข้อมูลพนักงาน";
    document.getElementById("employeeId").value = userId;
    document.getElementById("fullName").value = employee.fullName;
    document.getElementById("email").value = employee.email;
    document.getElementById("phone").value = employee.phone || "";
    document.getElementById("username").value = employee.username;
    document.getElementById("role").value = employee.role;
    document.getElementById("status").value = employee.status;

    // Disable fields that should not be edited
    document.getElementById("fullName").disabled = true;
    document.getElementById("phone").disabled = true;
    document.getElementById("email").disabled = true;
    document.getElementById("username").disabled = true;

    document.getElementById("statusField").classList.remove("hidden");

    const modal = document.getElementById("employeeModal");
    const modalContent = document.getElementById("employeeModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  /**
   * Close Employee Modal with Animation
   */
  function closeEmployeeModal() {
    const modal = document.getElementById("employeeModal");
    const modalContent = document.getElementById("employeeModalContent");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");
      document.getElementById("employeeForm").reset();
      employeeEditId = null;
    }, 50);
  }

  /**
   * Handle Form Submit
   */
  document
    .getElementById("employeeForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const session = getSessionFromStorage();
      if (!session || !session.sessionToken) {
        showToast("กรุณาเข้าสู่ระบบใหม่", "error");
        return;
      }

      let phoneValue = document.getElementById("phone").value.trim();
      // Auto-add leading zero if missing (9 digits starting with 6, 8, or 9)
      if (
        phoneValue.length === 9 &&
        (phoneValue.startsWith("6") ||
          phoneValue.startsWith("8") ||
          phoneValue.startsWith("9"))
      ) {
        phoneValue = "0" + phoneValue;
      }

      const employeeData = {
        fullName: document.getElementById("fullName").value,
        email: document.getElementById("email").value,
        phone: phoneValue,
        username: document.getElementById("username").value,
        role: document.getElementById("role").value,
        status: employeeEditId
          ? document.getElementById("status").value
          : "เปิดใช้งาน",
      };

      const functionName = employeeEditId ? "updateUser" : "createUser";
      const params = employeeEditId
        ? [session.sessionToken, employeeEditId, employeeData]
        : [session.sessionToken, employeeData];

      // Start Loading
      toggleEmployeeLoading(
        "submitEmployeeBtn",
        "submitBtnSpinner",
        "submitBtnText",
        true,
        "บันทึก",
        "กำลังบันทึก...",
      );

      google.script.run
        .withSuccessHandler(function (response) {
          // Stop Loading
          toggleEmployeeLoading(
            "submitEmployeeBtn",
            "submitBtnSpinner",
            "submitBtnText",
            false,
            "บันทึก",
            "กำลังบันทึก...",
          );

          if (response.success) {
            showToast(response.message, "success");
            closeEmployeeModal();
            loadEmployees();
          } else {
            showToast(response.message, "error");
          }
        })
        .withFailureHandler(function (error) {
          // Stop Loading
          toggleEmployeeLoading(
            "submitEmployeeBtn",
            "submitBtnSpinner",
            "submitBtnText",
            false,
            "บันทึก",
            "กำลังบันทึก...",
          );
          showToast("เกิดข้อผิดพลาด: " + error.message, "error");
        })
        [functionName](...params);
    });

  /**
   * Open Reset Password Modal with Animation
   */
  function openResetPasswordModal(userId, fullName) {
    document.getElementById("resetEmployeeId").value = userId;
    document.getElementById("resetEmployeeName").textContent = fullName;

    const modal = document.getElementById("resetPasswordModal");
    const modalContent = document.getElementById("resetPasswordModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  /**
   * Close Reset Password Modal with Animation
   */
  function closeResetPasswordModal() {
    const modal = document.getElementById("resetPasswordModal");
    const modalContent = document.getElementById("resetPasswordModalContent");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");
    }, 50);
  }

  /**
   * Confirm Reset Password
   */
  function confirmResetPassword() {
    const session = getSessionFromStorage();
    const userId = document.getElementById("resetEmployeeId").value;

    toggleEmployeeLoading(
      "confirmResetBtn",
      "resetSpinner",
      "resetBtnText",
      true,
      "รีเซ็ตรหัสผ่าน",
      "กำลังรีเซ็ต...",
    );

    google.script.run
      .withSuccessHandler(function (response) {
        toggleEmployeeLoading(
          "confirmResetBtn",
          "resetSpinner",
          "resetBtnText",
          false,
          "รีเซ็ตรหัสผ่าน",
          "กำลังรีเซ็ต...",
        );
        if (response.success) {
          showToast(response.message, "success");
          closeResetPasswordModal();
        } else {
          showToast(response.message, "error");
        }
      })
      .withFailureHandler(function (error) {
        toggleEmployeeLoading(
          "confirmResetBtn",
          "resetSpinner",
          "resetBtnText",
          false,
          "รีเซ็ตรหัสผ่าน",
          "กำลังรีเซ็ต...",
        );
        showToast("เกิดข้อผิดพลาด: " + error.message, "error");
      })
      .resetUserPassword(session.sessionToken, userId);
  }

  /**
   * Open Delete Modal
   */
  function deleteEmployeeModal(userId, fullName) {
    document.getElementById("deleteEmployeeId").value = userId;
    document.getElementById("deleteEmployeeName").textContent = fullName;

    const modal = document.getElementById("deleteEmployeeModal");
    const modalContent = document.getElementById("deleteEmployeeModalContent");

    modal.classList.remove("hidden");
    // Animation
    setTimeout(() => {
      modalContent.classList.remove("scale-95", "opacity-0");
      modalContent.classList.add("scale-100", "opacity-100");
    }, 10);
  }

  /**
   * Close Delete Modal
   */
  function closeDeleteModal() {
    const modal = document.getElementById("deleteEmployeeModal");
    const modalContent = document.getElementById("deleteEmployeeModalContent");

    modalContent.classList.remove("scale-100", "opacity-100");
    modalContent.classList.add("scale-95", "opacity-0");

    setTimeout(() => {
      modal.classList.add("hidden");
    }, 300);
  }

  /**
   * Confirm Delete
   */
  function confirmDeleteEmployee() {
    const session = getSessionFromStorage();
    const userId = document.getElementById("deleteEmployeeId").value;

    // Start Loading
    toggleEmployeeLoading(
      "confirmDeleteBtn",
      "deleteBtnSpinner",
      "deleteBtnText",
      true,
      "ลบข้อมูล",
      "กำลังลบ...",
    );

    google.script.run
      .withSuccessHandler(function (response) {
        // Stop Loading
        toggleEmployeeLoading(
          "confirmDeleteBtn",
          "deleteBtnSpinner",
          "deleteBtnText",
          false,
          "ลบข้อมูล",
          "กำลังลบ...",
        );

        if (response.success) {
          showToast(response.message, "success");
          closeDeleteModal();
          loadEmployees();
        } else {
          showToast(response.message, "error");
        }
      })
      .withFailureHandler(function (error) {
        // Stop Loading
        toggleEmployeeLoading(
          "confirmDeleteBtn",
          "deleteBtnSpinner",
          "deleteBtnText",
          false,
          "ลบข้อมูล",
          "กำลังลบ...",
        );
        showToast("เกิดข้อผิดพลาด: " + error.message, "error");
      })
      .deleteUser(session.sessionToken, userId);
  }

  // Load employees on page load
  loadEmployees();
  /**
   * Toggle User Status (Owner Only)
   */
  function toggleUserStatus(userId) {
    const session = getSessionFromStorage();
    if (!session) return;

    google.script.run
      .withSuccessHandler(function (response) {
        if (response.success) {
          showToast(response.message, "success");
          loadEmployees(); // Refresh data
        } else {
          showToast(response.message, "error");
        }
      })
      .withFailureHandler(function (error) {
        showToast("เกิดข้อผิดพลาด: " + error.message, "error");
      })
      .toggleUserStatus(session.sessionToken, userId);
  }

  function changeEmpPage(dir) {
    const totalPages = Math.ceil(empFilteredList.length / empItemsPerPage);
    if (dir === "prev" && empCurrentPage > 1) goToEmpPage(empCurrentPage - 1);
    else if (dir === "next" && empCurrentPage < totalPages)
      goToEmpPage(empCurrentPage + 1);
  }

  function goToEmpPage(page) {
    empCurrentPage = page;
    renderEmployees(empFilteredList);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function changeEmpPageSize() {
    const select = document.getElementById("empItemsPerPageSelect");
    if (select) {
      empItemsPerPage = parseInt(select.value);
      empCurrentPage = 1;
      renderEmployees(empFilteredList);
    }
  }
</script>
```
